# 需求文档：后端功能完善

## 简介

在上线前完善 Project Neon 后端的核心功能，包括邮箱验证、密码重置、关注系统、Token 刷新机制，以及修复现有 Bug。目标是提供一个生产就绪的后端系统。

## 术语表

- **邮箱验证**: 用户注册后通过邮件链接确认邮箱有效性
- **验证码**: 用于邮箱验证和密码重置的随机字符串
- **Refresh Token**: 用于获取新 Access Token 的长期令牌
- **关注系统**: 用户之间的关注/粉丝关系

## 需求列表

### 需求 1：邮箱验证

**用户故事:** 作为网站管理员，我希望用户注册时验证邮箱，以便确保用户提供的是真实有效的邮箱地址。

#### 验收标准

1. 当用户完成注册时，系统应发送包含验证链接的邮件到用户邮箱
2. 当用户点击验证链接时，系统应将用户状态标记为已验证
3. 当验证链接超过24小时时，系统应拒绝验证并提示链接已过期
4. 当未验证用户尝试登录时，系统应允许登录但返回未验证状态标识
5. 当用户请求重新发送验证邮件时，系统应生成新的验证链接并发送

### 需求 2：密码重置

**用户故事:** 作为用户，我希望能够重置忘记的密码，以便在忘记密码时恢复账户访问。

#### 验收标准

1. 当用户请求密码重置时，系统应发送包含重置链接的邮件到注册邮箱
2. 当用户点击重置链接时，系统应显示密码重置页面
3. 当重置链接超过1小时时，系统应拒绝重置并提示链接已过期
4. 当用户提交新密码时，系统应验证密码强度并更新密码哈希
5. 当密码重置成功时，系统应使该用户的所有现有 Token 失效

### 需求 3：密码强度验证

**用户故事:** 作为网站管理员，我希望强制用户使用强密码，以便提高账户安全性。

#### 验收标准

1. 当用户注册或重置密码时，系统应要求密码长度至少8个字符
2. 当密码不包含字母和数字组合时，系统应拒绝并提示密码要求
3. 当密码验证失败时，系统应返回具体的错误原因

### 需求 4：Token 刷新机制

**用户故事:** 作为用户，我希望不需要频繁重新登录，以便获得更好的使用体验。

#### 验收标准

1. 当用户登录成功时，系统应同时返回 Access Token 和 Refresh Token
2. 当 Access Token 过期时，系统应允许使用 Refresh Token 获取新的 Access Token
3. 当 Refresh Token 使用后，系统应生成新的 Refresh Token 并使旧的失效
4. 当 Refresh Token 超过7天时，系统应拒绝刷新并要求重新登录
5. 当用户登出时，系统应使当前的 Refresh Token 失效

### 需求 5：关注系统

**用户故事:** 作为用户，我希望能够关注其他用户，以便在动态流中看到他们的内容。

#### 验收标准

1. 当用户关注另一个用户时，系统应创建关注关系并通知被关注者
2. 当用户取消关注时，系统应删除关注关系
3. 当用户查看个人主页时，系统应显示关注数和粉丝数
4. 当用户获取关注列表时，系统应返回分页的关注用户列表
5. 当用户获取粉丝列表时，系统应返回分页的粉丝用户列表
6. 如果用户尝试关注自己，系统应拒绝操作

### 需求 6：用户头像上传

**用户故事:** 作为用户，我希望能够上传头像图片，以便个性化我的个人资料。

#### 验收标准

1. 当用户上传头像时，系统应验证图片格式为 JPEG、PNG 或 WebP
2. 当用户上传头像时，系统应限制文件大小不超过 2MB
3. 当头像上传成功时，系统应自动更新用户的头像 URL
4. 当用户有旧头像时，系统应删除旧头像文件以节省存储空间

### 需求 7：Bug 修复 - Gallery 分页

**用户故事:** 作为用户，我希望图库分页显示正确的总数，以便准确了解内容数量。

#### 验收标准

1. 当用户访问图库分类时，系统应返回该分类下图片的真实总数
2. 当用户翻页时，系统应正确计算偏移量并返回对应页的内容
3. 当分类不存在时，系统应返回 404 错误而非普通错误对象

### 需求 8：用户个人主页

**用户故事:** 作为用户，我希望能够查看其他用户的个人主页，以便了解他们的动态和信息。

#### 验收标准

1. 当用户访问个人主页时，系统应显示用户基本信息、动态数、关注数和粉丝数
2. 当用户访问个人主页时，系统应显示该用户的动态列表
3. 当已登录用户访问他人主页时，系统应显示是否已关注该用户
4. 当用户不存在时，系统应返回 404 错误

### 需求 9：数据库优化准备

**用户故事:** 作为开发者，我希望代码支持数据库迁移，以便未来可以从 SQLite 迁移到 PostgreSQL。

#### 验收标准

1. 当添加新模型时，系统应使用 Alembic 管理数据库版本
2. 当数据库结构变更时，系统应生成迁移脚本
3. 当部署时，系统应支持通过环境变量切换数据库连接
