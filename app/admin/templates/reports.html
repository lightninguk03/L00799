{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">
                    <i class="fa-solid fa-chart-bar me-2"></i>数据报表
                </h2>
                <p class="text-muted mb-0">查看系统数据统计和趋势分析</p>
            </div>
            <div>
                <a href="{{ request.url_for('admin:reports') }}?export=users" class="btn btn-outline-primary me-2">
                    <i class="fa-solid fa-download me-1"></i>导出用户
                </a>
                <a href="{{ request.url_for('admin:reports') }}?export=posts" class="btn btn-outline-success me-2">
                    <i class="fa-solid fa-download me-1"></i>导出动态
                </a>
                <a href="{{ request.url_for('admin:reports') }}?export=comments" class="btn btn-outline-info">
                    <i class="fa-solid fa-download me-1"></i>导出评论
                </a>
            </div>
        </div>
    </div>

    <!-- 时间范围选择 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <span class="me-3 text-muted">时间范围：</span>
                        <div class="btn-group" role="group">
                            <a href="{{ request.url_for('admin:reports') }}?days=7" 
                               class="btn btn-sm {{ 'btn-primary' if days == 7 else 'btn-outline-secondary' }}">
                                近7天
                            </a>
                            <a href="{{ request.url_for('admin:reports') }}?days=30" 
                               class="btn btn-sm {{ 'btn-primary' if days == 30 else 'btn-outline-secondary' }}">
                                近30天
                            </a>
                            <a href="{{ request.url_for('admin:reports') }}?days=90" 
                               class="btn btn-sm {{ 'btn-primary' if days == 90 else 'btn-outline-secondary' }}">
                                近90天
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 趋势图表 -->
    <div class="row mb-4">
        <div class="col-xl-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fa-solid fa-user-plus me-2"></i>用户注册趋势
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="userChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fa-solid fa-newspaper me-2"></i>动态发布趋势
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="postChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据汇总表格 -->
    <div class="row mb-4">
        <div class="col-xl-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fa-solid fa-folder me-2"></i>分类统计
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>分类名称</th>
                                    <th class="text-end">动态数</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cat in category_stats %}
                                <tr>
                                    <td>{{ cat.name }}</td>
                                    <td class="text-end">{{ cat.post_count }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted py-3">暂无数据</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fa-solid fa-trophy me-2"></i>活跃用户 TOP 10
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>用户名</th>
                                    <th class="text-end">动态数</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in top_users %}
                                <tr>
                                    <td>{{ user.username }}</td>
                                    <td class="text-end">{{ user.post_count }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted py-3">暂无数据</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fa-solid fa-fire me-2"></i>热门动态 TOP 10
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>内容</th>
                                    <th class="text-end">浏览量</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for post in top_posts %}
                                <tr>
                                    <td>
                                        <div class="text-truncate" style="max-width: 150px;">
                                            {{ post.content[:30] }}...
                                        </div>
                                    </td>
                                    <td class="text-end">{{ post.view_count }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted py-3">暂无数据</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 用户注册趋势图
const userCtx = document.getElementById('userChart').getContext('2d');
new Chart(userCtx, {
    type: 'line',
    data: {
        labels: {{ chart_labels | safe }},
        datasets: [{
            label: '新注册用户',
            data: {{ user_data | safe }},
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// 动态发布趋势图
const postCtx = document.getElementById('postChart').getContext('2d');
new Chart(postCtx, {
    type: 'line',
    data: {
        labels: {{ chart_labels | safe }},
        datasets: [{
            label: '新发布动态',
            data: {{ post_data | safe }},
            borderColor: '#1cc88a',
            backgroundColor: 'rgba(28, 200, 138, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}
