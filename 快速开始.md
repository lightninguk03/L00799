# Project Neon API 对接文档

## 启动后端服务

### Windows
```bash
双击运行 start.bat
```

### Linux/Mac
```bash
chmod +x start.sh
./start.sh
```

### 手动启动
```bash
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## 访问 API 文档

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

---

## API 基础信息

- 基础 URL: `http://localhost:8000`
- 认证方式: Bearer Token (JWT)
- 请求头: `Authorization: Bearer {access_token}`

---

## 1. 认证模块 `/auth`

### 1.1 用户注册
```http
POST /auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "username": "username",
  "password": "password123"
}
```

响应 201:
```json
{
  "id": 1,
  "email": "user@example.com",
  "username": "username",
  "avatar": null,
  "is_verified": false,
  "created_at": "2025-12-13T10:00:00"
}
```

### 1.2 用户登录
```http
POST /auth/login
Content-Type: application/x-www-form-urlencoded

username=user@example.com&password=password123
```

响应 200:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "abc123xyz...",
  "token_type": "bearer",
  "is_verified": false
}
```

### 1.3 刷新 Token
```http
POST /auth/refresh
Content-Type: application/json

{
  "refresh_token": "abc123xyz..."
}
```

### 1.4 用户登出
```http
POST /auth/logout
Content-Type: application/json

{
  "refresh_token": "abc123xyz..."
}
```

### 1.5 邮箱验证
```http
POST /auth/verify-email
Content-Type: application/json

{
  "code": "验证码字符串"
}
```

### 1.6 忘记密码
```http
POST /auth/forgot-password
Content-Type: application/json

{
  "email": "user@example.com"
}
```

### 1.7 重置密码
```http
POST /auth/reset-password
Content-Type: application/json

{
  "code": "重置码字符串",
  "new_password": "newpassword123"
}
```

### 1.8 获取当前用户
```http
GET /auth/me
Authorization: Bearer {token}
```

### 1.9 更新用户信息
```http
PUT /auth/me
Authorization: Bearer {token}
Content-Type: application/json

{
  "username": "新用户名"
}
```

### 1.10 上传头像
```http
POST /auth/me/avatar
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: 图片文件 (JPEG/PNG/WebP, 最大2MB)
```

### 1.11 获取用户统计
```http
GET /auth/me/stats
Authorization: Bearer {token}
```

响应:
```json
{
  "post_count": 10,
  "like_count": 25,
  "favorite_count": 8,
  "comment_count": 15
}
```

---

## 2. 用户模块 `/users`

### 2.1 获取用户主页
```http
GET /users/{user_id}
```

响应:
```json
{
  "id": 1,
  "username": "username",
  "avatar": "/uploads/avatars/xxx.jpg",
  "post_count": 10,
  "following_count": 50,
  "follower_count": 100,
  "is_following": false
}
```

### 2.2 获取用户动态
```http
GET /users/{user_id}/posts?page=1&page_size=20
```

### 2.3 关注用户
```http
POST /users/{user_id}/follow
Authorization: Bearer {token}
```

### 2.4 取消关注
```http
DELETE /users/{user_id}/follow
Authorization: Bearer {token}
```

### 2.5 获取关注列表
```http
GET /users/{user_id}/following?page=1&page_size=20
```

### 2.6 获取粉丝列表
```http
GET /users/{user_id}/followers?page=1&page_size=20
```

---

## 3. 动态模块 `/posts`

### 3.1 发布动态
```http
POST /posts/
Authorization: Bearer {token}
Content-Type: multipart/form-data

content: "动态内容"
category_id: 1
files: [图片/视频文件]
```

**文件限制**：
- 支持：图片 (JPEG, PNG, GIF, WebP)、视频 (MP4, WebM)
- 不支持：其他文件类型

### 3.2 获取动态列表
```http
GET /posts/?page=1&page_size=20&category_id=1
```

响应:
```json
{
  "total": 100,
  "page": 1,
  "page_size": 20,
  "items": [
    {
      "id": 1,
      "user_id": 1,
      "content": "动态内容",
      "media_type": "image",
      "media_urls": ["/uploads/images/xxx.jpg"],
      "thumbnail": null,
      "category_id": 1,
      "created_at": "2025-12-13T10:00:00",
      "like_count": 10,
      "comment_count": 5,
      "is_liked": false,
      "is_collected": false,
      "user": {
        "id": 1,
        "username": "用户名",
        "avatar": "头像URL"
      }
    }
  ]
}
```

### 3.3 获取我的动态
```http
GET /posts/me?page=1&page_size=20
Authorization: Bearer {token}
```

### 3.4 获取动态详情
```http
GET /posts/{id}
```

### 3.5 编辑动态
```http
PUT /posts/{id}
Authorization: Bearer {token}
Content-Type: multipart/form-data

content: "更新后的内容"
```

### 3.6 删除动态
```http
DELETE /posts/{id}
Authorization: Bearer {token}
```

### 3.7 点赞/收藏
```http
POST /posts/{id}/interact
Authorization: Bearer {token}
Content-Type: application/json

{
  "interaction_type": "like"
}
```

响应:
```json
{
  "action": "added"
}
```

### 3.8 发表评论
```http
POST /posts/{id}/comments
Authorization: Bearer {token}
Content-Type: application/json

{
  "content": "评论内容"
}
```

### 3.9 获取评论列表
```http
GET /posts/{id}/comments
```

### 3.10 转发动态
```http
POST /posts/{id}/repost
Authorization: Bearer {token}
Content-Type: multipart/form-data

content: "转发时的评论"
```

---

## 4. 图库模块 `/gallery`

### 4.1 获取分类列表
```http
GET /gallery/categories
```

响应:
```json
[
  {
    "id": 1,
    "name": "进击的巨人",
    "cover_image": "/uploads/covers/xxx.jpg"
  }
]
```

### 4.2 获取分类图片
```http
GET /gallery/{category_id}?page=1&page_size=30
```

---

## 5. 通知模块 `/notifications`

### 5.1 获取通知列表
```http
GET /notifications/?page=1&page_size=20&unread_only=true
Authorization: Bearer {token}
```

响应:
```json
{
  "total": 5,
  "items": [
    {
      "id": 1,
      "actor_username": "用户名",
      "actor_avatar": "头像URL",
      "type": "like",
      "post_id": 10,
      "is_read": false,
      "created_at": "2025-12-13T10:00:00"
    }
  ]
}
```

### 5.2 标记单条已读
```http
POST /notifications/{id}/read
Authorization: Bearer {token}
```

### 5.3 全部标记已读
```http
POST /notifications/read-all
Authorization: Bearer {token}
```

---

## 6. 搜索模块 `/search`

### 6.1 搜索动态
```http
GET /search/posts?q=关键词&page=1&page_size=20
```

### 6.2 搜索用户
```http
GET /search/users?q=关键词&page=1&page_size=20
```

---

## 7. AI 助手 `/ai`

### 7.1 与 AI 对话
```http
POST /ai/chat
Authorization: Bearer {token}
Content-Type: application/json

{
  "message": "你好"
}
```

响应:
```json
{
  "user_message": {
    "id": 1,
    "role": "user",
    "content": "你好",
    "created_at": "2025-12-13T10:00:00"
  },
  "assistant_message": {
    "id": 2,
    "role": "assistant",
    "content": "你好呀～欢迎来到闪电社区...",
    "created_at": "2025-12-13T10:00:01"
  }
}
```

---

## 8. 轮播图 `/banners`

### 8.1 获取轮播图列表
```http
GET /banners
```

### 8.2 上传轮播图
```http
POST /banners/upload
Authorization: Bearer {admin_token}
Content-Type: multipart/form-data

file: 图片文件
```

### 8.3 删除轮播图
```http
DELETE /banners/{index}
Authorization: Bearer {admin_token}
```

### 8.4 重新排序
```http
PUT /banners/reorder
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "order": [2, 0, 1]
}
```

---

## 9. 系统配置 `/system`

### 9.1 获取网站配置
```http
GET /system/config
```

响应:
```json
{
  "site_name": "LETAVERSE",
  "slogan": "The soul is infinite...",
  "slogan_cn": "灵魂无限...",
  "logo": "/uploads/images/logo.png",
  "favicon": "/uploads/images/favicon.ico",
  "background": "/uploads/images/bg.jpg",
  "hero_background": "/uploads/images/hero.jpg",
  "hero_banners": ["/uploads/banners/banner1.jpg"],
  "ai_kanban": "/uploads/images/kanban.png",
  "default_avatar": "/uploads/images/avatar.png",
  "ai": {
    "name": "Mu AI",
    "name_cn": "穆爱",
    "title": "Central Brain",
    "title_cn": "中枢脑",
    "greeting": "Hello~ I'm Mu ✨",
    "greeting_cn": "你好呀～我是穆爱 ✨"
  },
  "social_links": [
    {"name": "Instagram", "url": "https://...", "icon": "instagram"}
  ],
  "world_database": {...},
  "announcement": {...}
}
```

---

## 错误码说明

### 认证相关
| 错误码 | 说明 |
|--------|------|
| invalid_credentials | 用户名或密码错误 |
| unauthorized | 未授权，请先登录 |
| invalid_refresh_token | 无效的刷新令牌 |
| user_not_found | 用户不存在 |
| user_banned | 用户已被封禁 |
| email_already_exists | 邮箱已被注册 |
| username_already_exists | 用户名已被使用 |

### 密码相关
| 错误码 | 说明 |
|--------|------|
| password_too_short | 密码长度至少8个字符 |
| password_needs_letter | 密码必须包含字母 |
| password_needs_number | 密码必须包含数字 |

### 文件相关
| 错误码 | 说明 |
|--------|------|
| invalid_file_type | 不支持的文件格式 |
| file_too_large | 文件太大 |

### 用户封禁
当用户被封禁时，返回 403 错误：
```json
{
  "error_code": "user_banned",
  "message": "user_banned",
  "reason": "违反社区规定",
  "until": "2025-12-20T00:00:00"
}
```

---

## 前端集成建议

### Token 管理
```javascript
// 存储 Token
localStorage.setItem('access_token', response.access_token);
localStorage.setItem('refresh_token', response.refresh_token);

// 请求拦截器
axios.interceptors.request.use(config => {
  const token = localStorage.getItem('access_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 响应拦截器 - 自动刷新 Token
axios.interceptors.response.use(
  response => response,
  async error => {
    if (error.response?.status === 401) {
      const refreshToken = localStorage.getItem('refresh_token');
      if (refreshToken) {
        try {
          const res = await axios.post('/auth/refresh', { refresh_token: refreshToken });
          localStorage.setItem('access_token', res.data.access_token);
          localStorage.setItem('refresh_token', res.data.refresh_token);
          error.config.headers.Authorization = `Bearer ${res.data.access_token}`;
          return axios(error.config);
        } catch {
          localStorage.clear();
          window.location.href = '/login';
        }
      }
    }
    return Promise.reject(error);
  }
);
```

---

## API 限流

| 接口 | 限制 |
|------|------|
| POST /auth/register | 3次/分钟 |
| POST /auth/login | 5次/分钟 |
| POST /auth/forgot-password | 3次/分钟 |
| POST /ai/chat | 10次/分钟 |
| POST /posts/ | 20次/分钟 |

超出限制返回 429 错误：
```json
{
  "error": "Rate limit exceeded: 5 per 1 minute"
}
```

---

## 邮件服务配置

如需启用邮箱验证和密码重置功能，在 `.env` 中配置：

```env
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=your_email@qq.com
SMTP_PASSWORD=your_auth_code
FROM_EMAIL=your_email@qq.com
FRONTEND_URL=http://localhost:3000
```

**QQ 邮箱授权码获取**：
1. 登录 QQ 邮箱网页版
2. 设置 → 账户 → 开启 SMTP 服务
3. 发送短信获取授权码


