# Project Neon 后端部署指南

## 一、环境要求

| 组件 | 版本要求 | 说明 |
|------|----------|------|
| Python | 3.10+ | 推荐 3.11 |
| SQLite | 内置 | 默认数据库 |
| PostgreSQL | 12+ | 可选，生产环境推荐 |
| FFmpeg | 最新版 | 可选，视频转码和缩略图生成 |

## 二、本地开发部署

### 2.1 获取代码

```bash
git clone <仓库地址> project-neon
cd project-neon
```

### 2.2 创建虚拟环境

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python3 -m venv venv
source venv/bin/activate
```

### 2.3 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖：
- `fastapi` - Web 框架
- `uvicorn` - ASGI 服务器
- `sqlmodel` - ORM
- `python-jose` - JWT 认证
- `sqladmin` - 管理后台
- `openai` - AI 对话
- `Pillow` - 图片处理
- `alembic` - 数据库迁移

### 2.4 配置环境变量

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```env
# 必须配置
SECRET_KEY=<至少32字符的随机字符串>

# 可选配置
DEBUG=False
DATABASE_URL=sqlite:///./neon.db
OPENAI_API_KEY=<你的API密钥>
OPENAI_MODEL=deepseek-chat
```

生成 SECRET_KEY：
```bash
# Linux/Mac
openssl rand -hex 32

# Windows PowerShell
-join ((1..32) | ForEach-Object { '{0:x2}' -f (Get-Random -Maximum 256) })
```

### 2.5 初始化

```bash
# 创建上传目录
mkdir -p uploads/images uploads/videos uploads/thumbnails

# 初始化网站配置
python init_config.py

# 创建管理员账号
python init_admin.py
# 或指定用户名密码
python init_admin.py admin Admin123
```

### 2.6 启动服务

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

或使用启动脚本：
- Windows: `start.bat`
- Linux/Mac: `./start.sh`

### 2.7 访问

- API 文档: http://localhost:8000/docs
- 管理后台: http://localhost:8000/admin

---

## 三、生产环境部署 (Ubuntu/Debian)

### 3.1 服务器准备

```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Python 3.11
apt install -y python3.11 python3.11-venv python3-pip

# 安装 Nginx
apt install -y nginx

# 安装 FFmpeg（可选，用于视频处理）
apt install -y ffmpeg
```

### 3.2 创建项目目录

```bash
mkdir -p /var/www/neon
cd /var/www/neon
```

### 3.3 上传代码

```bash
# 方式一：Git 克隆
git clone <仓库地址> backend

# 方式二：本地上传
scp -r ./project-neon root@服务器IP:/var/www/neon/backend
```

### 3.4 配置 Python 环境

```bash
cd /var/www/neon/backend

# 创建虚拟环境
python3.11 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 3.5 配置环境变量

```bash
cp .env.example .env
nano .env
```

生产环境配置：
```env
DEBUG=False
SECRET_KEY=<生成的随机密钥>
DATABASE_URL=sqlite:///./neon.db

# AI 服务
OPENAI_API_KEY=<你的API密钥>
OPENAI_MODEL=deepseek-chat

# CORS（改为你的前端地址）
CORS_ORIGINS=["https://你的域名"]

# 前端 URL
FRONTEND_URL=https://你的域名
```

### 3.6 初始化数据库

```bash
source venv/bin/activate

# 运行数据库迁移
alembic upgrade head

# 初始化配置
python init_config.py

# 创建管理员
python init_admin.py
```

### 3.7 创建 Systemd 服务

```bash
nano /etc/systemd/system/neon-backend.service
```

写入：
```ini
[Unit]
Description=Project Neon Backend
After=network.target

[Service]
User=root
WorkingDirectory=/var/www/neon/backend
Environment="PATH=/var/www/neon/backend/venv/bin"
ExecStart=/var/www/neon/backend/venv/bin/uvicorn app.main:app --host 127.0.0.1 --port 8000
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
systemctl daemon-reload
systemctl enable neon-backend
systemctl start neon-backend
systemctl status neon-backend
```

### 3.8 配置 Nginx

```bash
nano /etc/nginx/sites-available/neon
```

写入：
```nginx
server {
    listen 80;
    server_name 你的域名或IP;

    # 后端 API
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # AI 接口（需要更长超时）
    location /ai/ {
        proxy_pass http://127.0.0.1:8000/ai/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 120s;
    }

    # 上传文件（静态资源）
    location /uploads/ {
        alias /var/www/neon/backend/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 文件上传大小限制
    client_max_body_size 100M;
}
```

启用配置：
```bash
ln -s /etc/nginx/sites-available/neon /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t
systemctl restart nginx
```

### 3.9 配置防火墙

```bash
ufw allow 22
ufw allow 80
ufw allow 443
ufw enable
```

云服务器还需在控制台开放端口 80、443。

---

## 四、HTTPS 配置（推荐）

```bash
# 安装 Certbot
apt install -y certbot python3-certbot-nginx

# 申请证书
certbot --nginx -d 你的域名

# 自动续期测试
certbot renew --dry-run
```

---

## 五、PostgreSQL 配置（可选）

生产环境推荐使用 PostgreSQL：

```bash
# 安装
apt install -y postgresql postgresql-contrib

# 创建数据库
sudo -u postgres psql
CREATE DATABASE neon;
CREATE USER neon WITH PASSWORD '你的密码';
GRANT ALL PRIVILEGES ON DATABASE neon TO neon;
\q
```

修改 `.env`：
```env
DATABASE_URL=postgresql://neon:你的密码@localhost/neon
```

安装驱动：
```bash
pip install psycopg2-binary
```

---

## 六、运维命令

```bash
# 查看后端日志
journalctl -u neon-backend -f

# 重启后端
systemctl restart neon-backend

# 重启 Nginx
systemctl restart nginx

# 进入虚拟环境
cd /var/www/neon/backend
source venv/bin/activate

# 数据库迁移
alembic upgrade head

# 创建新管理员
python init_admin.py 用户名 密码
```

---

## 七、备份

```bash
# 备份数据库
cp /var/www/neon/backend/neon.db /backup/neon_$(date +%Y%m%d).db

# 备份上传文件
tar -czf /backup/uploads_$(date +%Y%m%d).tar.gz /var/www/neon/backend/uploads

# 定时备份（每天凌晨3点）
crontab -e
# 添加：
0 3 * * * cp /var/www/neon/backend/neon.db /backup/neon_$(date +\%Y\%m\%d).db
```

---

## 八、常见问题

### Q: 502 Bad Gateway
后端服务未启动，检查：
```bash
systemctl status neon-backend
journalctl -u neon-backend -n 50
```

### Q: 上传文件失败
检查目录权限：
```bash
chmod -R 755 /var/www/neon/backend/uploads
```

### Q: AI 聊天超时
增加 Nginx 超时时间，或检查 API 密钥是否有效。

### Q: 数据库迁移失败
```bash
# 查看当前版本
alembic current

# 重置迁移
alembic downgrade base
alembic upgrade head
```

### Q: 视频无法播放
安装 FFmpeg 后重新上传，系统会自动转码为 H.264 格式。

---

## 九、部署检查清单

- [ ] Python 3.10+ 安装成功
- [ ] 虚拟环境创建并激活
- [ ] 依赖安装完成
- [ ] `.env` 配置正确（SECRET_KEY 必填）
- [ ] 数据库初始化完成
- [ ] 管理员账号创建成功
- [ ] 后端服务启动成功
- [ ] Nginx 配置正确
- [ ] 防火墙端口开放
- [ ] 访问 `/docs` 能看到 API 文档
- [ ] 访问 `/admin` 能登录管理后台
- [ ] 文件上传功能正常
