# Project Neon 后端生产部署任务清单

## 一、服务器准备

- [ ] 1.1 SSH 连接服务器
  ```bash
  ssh root@服务器IP
  ```

- [ ] 1.2 更新系统
  ```bash
  apt update && apt upgrade -y
  ```

- [ ] 1.3 安装 Python 3.11
  ```bash
  apt install -y python3.11 python3.11-venv python3-pip
  ```

- [ ] 1.4 安装 Nginx
  ```bash
  apt install -y nginx
  ```

- [ ] 1.5 安装 FFmpeg（可选，视频处理需要）
  ```bash
  apt install -y ffmpeg
  ```

---

## 二、项目部署

- [ ] 2.1 创建项目目录
  ```bash
  mkdir -p /var/www/neon
  cd /var/www/neon
  ```

- [ ] 2.2 上传后端代码
  ```bash
  # Git 克隆
  git clone <仓库地址> backend
  # 或本地上传
  scp -r ./project-neon root@服务器IP:/var/www/neon/backend
  ```

- [ ] 2.3 创建虚拟环境
  ```bash
  cd /var/www/neon/backend
  python3.11 -m venv venv
  source venv/bin/activate
  ```

- [ ] 2.4 安装依赖
  ```bash
  pip install -r requirements.txt
  ```

---

## 三、配置

- [ ] 3.1 创建 .env 文件
  ```bash
  cp .env.example .env
  nano .env
  ```

- [ ] 3.2 生成 SECRET_KEY
  ```bash
  openssl rand -hex 32
  ```

- [ ] 3.3 配置环境变量
  ```env
  DEBUG=False
  SECRET_KEY=<生成的密钥>
  DATABASE_URL=sqlite:///./neon.db
  OPENAI_API_KEY=<你的API密钥>
  OPENAI_MODEL=deepseek-chat
  CORS_ORIGINS=["https://你的域名"]
  FRONTEND_URL=https://你的域名
  ```

---

## 四、初始化

- [ ] 4.1 创建上传目录
  ```bash
  mkdir -p uploads/images uploads/videos uploads/thumbnails
  ```

- [ ] 4.2 运行数据库迁移
  ```bash
  source venv/bin/activate
  alembic upgrade head
  ```

- [ ] 4.3 初始化网站配置
  ```bash
  python init_config.py
  ```

- [ ] 4.4 创建管理员账号
  ```bash
  python init_admin.py
  ```

---

## 五、Systemd 服务

- [ ] 5.1 创建服务文件
  ```bash
  nano /etc/systemd/system/neon-backend.service
  ```

- [ ] 5.2 写入服务配置
  ```ini
  [Unit]
  Description=Project Neon Backend
  After=network.target

  [Service]
  User=root
  WorkingDirectory=/var/www/neon/backend
  Environment="PATH=/var/www/neon/backend/venv/bin"
  ExecStart=/var/www/neon/backend/venv/bin/uvicorn app.main:app --host 127.0.0.1 --port 8000
  Restart=always
  RestartSec=3

  [Install]
  WantedBy=multi-user.target
  ```

- [ ] 5.3 启动服务
  ```bash
  systemctl daemon-reload
  systemctl enable neon-backend
  systemctl start neon-backend
  ```

- [ ] 5.4 验证服务状态
  ```bash
  systemctl status neon-backend
  ```

---

## 六、Nginx 配置

- [ ] 6.1 创建 Nginx 配置文件
  ```bash
  nano /etc/nginx/sites-available/neon
  ```

- [ ] 6.2 写入配置
  ```nginx
  server {
      listen 80;
      server_name 你的域名或IP;

      location / {
          proxy_pass http://127.0.0.1:8000;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
      }

      location /ai/ {
          proxy_pass http://127.0.0.1:8000/ai/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_read_timeout 120s;
      }

      location /uploads/ {
          alias /var/www/neon/backend/uploads/;
          expires 30d;
          add_header Cache-Control "public, immutable";
      }

      client_max_body_size 100M;
  }
  ```

- [ ] 6.3 启用配置
  ```bash
  ln -s /etc/nginx/sites-available/neon /etc/nginx/sites-enabled/
  rm -f /etc/nginx/sites-enabled/default
  ```

- [ ] 6.4 测试并重启 Nginx
  ```bash
  nginx -t
  systemctl restart nginx
  ```

---

## 七、防火墙

- [ ] 7.1 配置 UFW
  ```bash
  ufw allow 22
  ufw allow 80
  ufw allow 443
  ufw enable
  ```

- [ ] 7.2 云服务器控制台开放端口 80、443

---

## 八、HTTPS（推荐）

- [ ] 8.1 安装 Certbot
  ```bash
  apt install -y certbot python3-certbot-nginx
  ```

- [ ] 8.2 申请 SSL 证书
  ```bash
  certbot --nginx -d 你的域名
  ```

- [ ] 8.3 测试自动续期
  ```bash
  certbot renew --dry-run
  ```

---

## 九、验证部署

- [ ] 9.1 访问 API 文档
  ```
  http://你的域名/docs
  ```

- [ ] 9.2 访问管理后台
  ```
  http://你的域名/admin
  ```

- [ ] 9.3 测试文件上传功能

- [ ] 9.4 测试 AI 对话功能（如已配置）

---

## 十、备份配置（可选）

- [ ] 10.1 创建备份目录
  ```bash
  mkdir -p /backup
  ```

- [ ] 10.2 设置定时备份
  ```bash
  crontab -e
  # 添加：
  0 3 * * * cp /var/www/neon/backend/neon.db /backup/neon_$(date +\%Y\%m\%d).db
  ```

---

## 部署完成检查

| 检查项 | 状态 |
|--------|------|
| 后端服务运行正常 | ☐ |
| Nginx 代理正常 | ☐ |
| API 文档可访问 | ☐ |
| 管理后台可登录 | ☐ |
| 文件上传正常 | ☐ |
| HTTPS 已启用 | ☐ |
